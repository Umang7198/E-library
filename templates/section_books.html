<!DOCTYPE html>
<html>
<head>
    <title>{{ section.title }} - Books</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .title {
            text-align: center;
            margin-bottom: 20px;
        }
        .search-box {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        .search-box input[type="text"] {
            width: 10cm;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        .search-box button {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
        }
        .book-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            display: inline-block;
            width: calc(33% - 20px);
        }
    </style>
    <script>
        function showIssueOptions(bookId) {
            const selectedUserId = document.getElementById('user-select-' + bookId).value;
            if (selectedUserId) {
                document.getElementById('issue-options-' + bookId + '-' + selectedUserId).style.display = 'block';
            }
        }
    </script>
</head>
<body>
<div>
    <h2 class="title">{{ section.title }} - Books</h2>
    <div class="search-box">
        <form action="{{ url_for('view_books', section_id=section.id) }}" method="GET" style="display: flex; width: 100%;">
            <input type="text" placeholder="Search books by title" name="query">
            <button type="submit">Search</button>
        </form>
    </div>

    <div>
        {% for book in books %}
        <div class="book-card">
            <h3>{{ book.title }}</h3>
            <p>Author: {{ book.author }}</p>

            <!-- New section to display issued users and options -->
            <div>
                <h4>Issued Users:</h4>
                <select id="user-select-{{ book.id }}" onchange="showIssueOptions({{ book.id }})">
                    <option value="">Select user</option>
                    {% for issue in book.issues %}
                        {% if issue.status == 'issued' %}
                            <option value="{{ issue.user_id }}">{{ issue.user.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                {% for issue in book.issues %}
                    {% if issue.status == 'issued' %}
                        <div id="issue-options-{{ book.id }}-{{ issue.user_id }}" style="display: none;">
                            <p>User: {{ issue.user.name }}</p>
                            <p>Issued Date: {{ issue.date_issued.strftime('%Y-%m-%d') }}</p>
                            <p>Due Date: {{ issue.due_date.strftime('%Y-%m-%d') if issue.due_date else 'N/A' }}</p>
                            <form action="{{ url_for('revoke_issue', issue_id=issue.id) }}" method="post" onsubmit="return confirm('Are you sure you want to revoke this issue?');">
                                <button type="submit" class='btn-warning'>Revoke Access</button>
                            </form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Delete Book Button -->
            <form action="{{ url_for('delete_book', book_id=book.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this book?');">
                <button type="submit" class='btn-danger'>Delete Book</button>
            </form>
        </div>
        {% else %}
        <p>No books in this section yet.</p>
        {% endfor %}
    </div>
    <a href="{{ url_for('add_book', section_id=section.id) }}">Add Book</a> | 
    <a href="{{ url_for('librarian_dashboard') }}">Back to Dashboard</a>
</div>
</body>
</html>
